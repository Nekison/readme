#!/bin/sh
# Start/stop the sdc-tree-api daemon.
# This file was autogenerated by node-deb 0.10.4
#
### BEGIN INIT INFO
# Provides:          sdc-tree-api
# Required-Start:    $remote_fs $syslog $network
# Required-Stop:     $remote_fs $syslog $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description: API for work with SDC data in the way of tree api
### END INIT INFO

set -u

SCRIPT="python3 -m rtdb-sync-pub -c etc/rtdb-sync-pub.cfg"
USER="rtdb-sync-pub"
NAME="rtdb-sync-pub"
WORKING_DIRECTORY="/usr/share/rtdb-sync-pub"
DESCRIPTION="Real Time Database Synchronization Publisher"

. /lib/lsb/init-functions
. "/etc/default/rtdb-sync-pub"

LOGDIR="/var/log/rtdb-sync-pub"
LOGFILE="$LOGDIR/rtdb-sync-pub.log"

mkdir -p "$LOGDIR"
chown -R "rtdb-sync-pub:rtdb-sync-pub" "$LOGDIR"

do_start() {
  start-stop-daemon --start \
    --user "$USER" --chuid "$USER" \
    --background --chdir "$WORKING_DIRECTORY" \
    --startas "/bin/sh" -- -c "exec $SCRIPT >> $LOGFILE 2>&1"
}

do_stop() {
  start-stop-daemon --stop \
    --user "$USER" --chuid "$USER" \
    --retry=5
}

do_status() {
  start-stop-daemon --status \
    --user "$USER" --chuid "$USER"
}

case "$1" in
  start)
    log_daemon_msg "Starting $DESCRIPTION" "$NAME"
    do_start
    case "$?" in
      0)
        log_end_msg 0
        ;;
      1)
        log_progress_msg "already started"
        log_end_msg 0
        ;;
      *)
        log_end_msg 1
        ;;
    esac
    ;;
  stop)
    log_daemon_msg "Stopping $DESCRIPTION" "$NAME"
    do_stop
    case "$?" in
      0)
        log_end_msg 0
        ;;
      1)
        log_progress_msg "already stopped"
        log_end_msg 0
        ;;
      *)
        log_end_msg 1
        ;;
    esac
    ;;
  restart|force-reload)
    $0 stop
    $0 start
    ;;
  try-restart)
    $0 status >/dev/null 2>&1 && $0 restart
    ;;
  status)
    do_status
    status="$?"
    case "$status" in
      0)
        log_success_msg "$NAME is running"
        ;;
      4)
        log_failure_msg "status of $NAME could not be determined"
        ;;
      *)
        log_failure_msg "$NAME is not running"
        ;;
    esac
    exit "$status"
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|force-reload|try-restart|status}" >&2
    exit 3
    ;;
esac
